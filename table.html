<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<meta name="google-signin-client_id" content="583488732443-0qrkltufodphbtveim4vv0nhsf5qijog.apps.googleusercontent.com">
<link rel="stylesheet" type="text/css" href="table.css">

<html>
    <head>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script src="https://apis.google.com/js/platform.js" async defer></script>
        
        <!--<script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>-->
        
        <link href="https://fonts.googleapis.com/css?family=Alegreya|Courgette|Lobster+Two" rel="stylesheet">
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-database.js"></script>
    </head>
    <body>
    <button type ="button" class="btn btn-primary" onclick="Clear()">Clear</button>
    <button type ="button" class="btn btn-primary" onclick="signOut()">Sign Out1</button>
    <div class="container">
      <table class="table table-bordered"  id="myTable">
        <thead>
          <tr>
            <th>Period #7</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
          </tr>
        </thead>
        <tbody>
          <!--<tr>
            <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td>
          </tr>
          <tr>
            <td>2</td><td>2</td><td>2</td><td>2</td><td>2</td>
          </tr>
          <tr>
            <td>3</td><td>3</td><td>3</td><td>3</td><td>3</td>
          </tr>
          <tr>
            <td>4</td><td>4</td><td>4</td><td>4</td><td>4</td>
          </tr>-->
        </tbody>
      </table>
    </div>
    <script>
        var already = 0;
        var availability = [];
        for(var rr = 0;rr < 5;rr++){
            availability[rr] = [];
            for(var r = 0;r < 4;r++){
                availability[rr][r] = 0;
                console.log("here's your stupid number " + availability[rr][r]);
            }
        }
       // availability goes [day][period]
        var config = {
          apiKey: "AIzaSyB7quSFbdzOHH_S4B1TOntym_xTj4Yx6To",
          authDomain: "chrome-calendar.firebaseapp.com",
          databaseURL: "https://chrome-calendar.firebaseio.com",
          storageBucket: "chrome-calendar.appspot.com",
          messagingSenderId: "583488732443"
        };
        firebase.initializeApp(config);
        firebase.database().ref('/users').once('value').then(function(snapshot) {
          var username = snapshot.val();
          //alert(username);
          // ...
        });
        var Ref = firebase.database().ref();
        Ref.on("value", function(snapshot) {
              var reset = snapshot.val();
              //var started = sessionStorage.getItem('start');
              //alert("Been set " + reset.beenSet);
               if(reset.beenSet === "false"){
                   refill();
                   var updates = {};
                   updates['/beenSet'] = "true";
                   firebase.database().ref().update(updates);
                   /*firebase.database().ref().set({
                       beenSet = "true"
                   });*/
                   if(already === 0){
                       already = 1;
                       startFunc();
                   }
               }
               alert("alert " + already);
               if(already === 0){
                   // Save data to sessionStorage
                   //sessionStorage.setItem('key', 1);
                   already = 1;
                   startFunc();
               }
        });
        var UID = sessionStorage.getItem('UID');
        function signOut(){
            firebase.auth().signOut().then(function() {
              // Sign-out successful.
                //alert("yo signing out");
                window.location.href="index.html";
            }, function(error) {
              // An error happened.
            });
        }
        //alert("UID " + UID);
        function refill(){
             for(var n = 0;n < 6;n++){
                 var cartLink;
                 var floor;
                 if(n === 0){
                     cartLink = "cart1";
                     floor = 0;
                 }
                 else if(n === 1){
                     cartLink = "cart2";
                     floor = 0;
                 }
                 else if(n === 2){
                     cartLink = "cart3";
                     floor = 1;
                 }
                 else if(n === 3){
                     cartLink = "cart4";
                     floor = 1;
                 }
                 else if(n === 4){
                     cartLink = "cart5";
                     floor = 2;
                 }
                 else if(n === 5){
                     cartLink = "cart6";
                     floor = 2;
                 }
                 for(var w = 0;w < 4;w++){
                     firebase.database().ref('/carts/' + cartLink + "/availability/" + w.toString()).set({
                        one: "true",
                        two: "true",
                        three: "true",
                        four: "true",
                        five: "true"
                      });
                 }
                 //Fill(cartLink,floor,addFloor);
                 
             }
            //alert("calling");
            //startFunc();
        }
       /* function Fill(cartLink,floor,callback){
            for(var w = 0;w < 4;w++){
                     firebase.database().ref('/carts/' + cartLink + "/availability/" + w.toString()).set({
                        one: "true",
                        two: "true",
                        three: "true",
                        four: "true",
                        five: "true"
                      });
                 }
            //callback(cartLink,floor);
        }*/
        /*function addFloor(cartLink,floor){
            firebase.database().ref("/carts/" + cartLink).set({
                 floor: floor
            });
        }*/
        var taken = [];
        var selected = [];
        for(var p = 0;p < 5;p++){
            taken[p] = [];
        }
        function Clickable (numID, color,yesList) {
            this.numID = numID;
            this.yesList = [];
            
        }
        //startFunc();
        function startFunc(){
            var j = 0;
            var k = 0;
            var dfd = $.Deferred();
            for(var x = 0;x < 6;x++){
                for(j = 0;j < 4;j++){
                    for(k = 0;k < 5;k++){

                        checkAvailable(j,k,x);
                        //var temp = Math.floor((Math.random() * 2));
                        //console.log("temp "+temp);
                        console.log("really " + j +"what " + k);


                    }
                }
            }
        }
        function checkAvailable(j,k,x){
            //j is period, k is day
            //x is cart
            var cartVal = "cart" + x.toString();
            console.log("here's your val " + cartVal);
            var kVal = 0;
            if(k == 0){
                kVal = "one";
            }
            else if(k == 1){
                kVal = "two";
            }
            else if(k == 2){
                kVal = "three";
            }
            else if(k == 3){
                kVal = "four";
            }
            else if(k == 4){
                kVal = "five";
            }
            console.log("kVal " + kVal);
            
            var freeCarts = false;
            var numAvail = 0;
                var cartsRef = firebase.database().ref("/carts/" + cartVal + "/availability/"+ j + "/" + kVal);
                cartsRef.on("value", function(snapshot) {
                    var available = snapshot.val()
                    
                    console.log("availability " + available);
                    if(available == "true"){
                        console.log("yo12");
                        freeCarts = true;
                    }
                    else if(available == "false"){
                        freeCarts = false;
                    }
                        
                    if(freeCarts == true){
                        //console.log("we are about to say yes");
                        //taken[j][k] = "yes";
                        availability[k][j] += 1;
                        console.log("panda " + availability[k][j]);
                        //taken[j][k] += 1;
                        //alert("say yes");
                    }
                    else if(freeCarts == false){
                        //taken[j][k] = "no";
                        console.log("say no");
                    }
                    
                    console.log("j" + j);
                    console.log("k" + k);
                    //console.log("count" + count);
                    //console.log("numcarts" + numCarts);
                    if((j === 3) && (k === 4) && (x === 5)){
                           alert("go again mate");
                           console.log("WE ARE MAKING A CALL");
                           account();
                           //myFunction();
                     }
                    /*var numCarts = snapshot.numChildren();
                    var count = 0;
                  // The callback function will get called twice, once for "fred" and once for "barney"
                    //console.log("in cartsref");
                    snapshot.forEach(function(childSnapshot) {
                    count++;
                   // console.log("per cart");
                    // key will be "fred" the first time and "barney" the second time
                    //var key = childSnapshot.key();
                    // childData will be the actual contents of the child
                    var available = childSnapshot.val();
                    //var available = childData.
                    //var available = childData.availability.child(kVal).val();
                    console.log("availability " + available);
                    if(available == "true"){
                        console.log("yo12");
                        freeCarts = true;
                    }
                    else if(available == "false"){
                        freeCarts = false;
                    }
                        
                    if(freeCarts == true){
                        //console.log("we are about to say yes");
                        taken[j][k] = "yes";
                        alert("say yes");
                    }
                    else if(freeCarts == false){
                        taken[j][k] = "no";
                        console.log("say no");
                    }
                    console.log("j" + j);
                    console.log("k" + k);
                    console.log("count" + count);
                    console.log("numcarts" + numCarts);
                    if((j === 3) && (k === 4) && (count === numCarts)){
                            alert("go again mate");
                           console.log("WE ARE MAKING A CALL");
                           myFunction();
                     }
                  });*/
                    
                });
        }
        function account(){
            for(var ii = 0;ii < 5;ii++){
                for(var jj = 0;jj < 4;jj++){
                    alert("availability " + availability[ii][jj]);
                    if(availability[ii][jj] !== 0){
                        taken[ii][jj] = "yes";
                    }
                    else{
                        taken[ii][jj] = "no";
                    }
                }
            }
            myFunction();
        }
        //myFunction();
        function myFunction(){
         var clicked = 0;
         console.log("yoyoy");
            for(var i = 0;i < 4;i++){
                var one = taken[clicked][0];
                var two = taken[clicked][1];
                var three = taken[clicked][2];
                var four = taken[clicked][3];
                var five = taken[clicked][4];
                clicked++;
                $('#myTable tr:last').after('<tr><td>'+(i+1)+'</td><td class=' + one +'  id= '+(1+i*5).toString()+'>'+(1+i*5).toString()+'</td><td class=' + two +' id= '+(2+i*5).toString()+'>'+(2+i*5).toString()+'</td><td class=' + three +' id= '+(3+i*5).toString()+'>'+(3+i*5).toString()+'</td><td class=' + four +' id= '+(4+i*5).toString()+'>'+(4+i*5).toString()+'</td>'+(5+i*5).toString()+'<td class=' + five +' id=  '+(5+i*5).toString()+'>'+(5+i*5).toString()+'</td></tr>'); 
            }
            //$('#myTable tr:last').remove();
        }
        $(document).ready(function() {
            $("table").click(function(event) {
                //alert(event.target.id);
                var ID = event.target.id;
                var Color = $('#'+ID).attr("class");
                //alert("color " + Color);
                if(Color === 'yes'){
                    $('#'+ID).css('background-color','gold');
                    $('#'+ID).css('color','black');
                    selected.push(new Clickable(ID,Color));
                }
            });
        });
        
        function Clear(){
            console.log("sup");
            for(var q = 0;q < selected.length;q++){
                console.log("rawr" + selected.length);
                var tagOne;
                var tagTwo;
                var tempInt = parseInt(selected[q].numID,10);
                
                //alert("wup");
                if((tempInt >= 1) && (tempInt <= 5)){
                    tagOne = '0';
                    tagTwo = tempInt ;
                }
                else if((tempInt  >= 6) && (tempInt <= 10)){
                    tagOne = '1';
                    tagTwo = tempInt  - 5;
                }
                else if((tempInt  >= 11) && (tempInt  <= 15)){
                    tagOne = '2';
                    tagTwo = tempInt  - 10;
                }
                else if((tempInt >= 16) && (tempInt  <= 20)){
                    tagOne = '3';
                    tagTwo = tempInt - 15;
                }
                
                if(tagTwo === 1){
                    tagTwo = "one";
                }
                else if(tagTwo === 2){
                    tagTwo = "two";
                }
                else if(tagTwo === 3){
                    tagTwo = "three";
                }
                else if(tagTwo === 4){
                    tagTwo = "four";
                }
                else if(tagTwo === 5){
                    tagTwo = "five";
                }
                
                //alert(tagOne);
                alert("tagTwo " + tagTwo);
                newUpdate(tagOne, tagTwo);
                 //var updates = {};
                  //updates['/carts/cart1/availability/' + tagOne + '/' + tagTwo] = "false";
                  //firebase.database().ref().update(updates);
                
                console.log("x0x");
                if(selected[q].color === "no"){
                    $('#'+selected[q].numID).css('background-color','#0d1a26');
                    $('#'+selected[q].numID).css('color','white');
                }
                else{
                    $('#'+selected[q].numID).css('background-color','#00ccff');
                    $('#'+selected[q].numID).css('color','black');
                }
            }
            selected.length = 0;
            console.log("here's where it went south");
            ClearTable(4);
            //startFunc();
        }
        function newUpdate(tagOne, tagTwo){
            var updates = {};
            updates['/carts/cart1/availability/' + tagOne + '/' + tagTwo] = "false";
            firebase.database().ref().update(updates);
        }
        function ClearTable(until){
            for(var t = 0; t < until;t++){
                console.log("trying to clear here");
                $('#myTable tr:last').remove();
            }
            startFunc();
        }
    </script>
    </body>
</html>
