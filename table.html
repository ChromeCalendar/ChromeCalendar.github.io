<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<meta name="google-signin-client_id" content="583488732443-0qrkltufodphbtveim4vv0nhsf5qijog.apps.googleusercontent.com">
<link rel="stylesheet" type="text/css" href="table.css">

<html>
    <head>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script src="https://apis.google.com/js/platform.js" async defer></script>
        
        <!--<script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>-->
        
        <link href="https://fonts.googleapis.com/css?family=Alegreya|Courgette|Lobster+Two" rel="stylesheet">
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase-database.js"></script>
    </head>
    <body>
    <!--<button type ="button" class="btn btn-primary" onclick="Clear()">Clear</button>-->
    <button type ="button" class="btn btn-primary" onclick="signOut()">Sign Out3</button>
    <!--<div class="container">
  <h2>Form control: select</h2>
  <p>The form below contains two dropdown menus (select lists):</p>-->
    <div class="container">
      <label for="sel1">Select floor:</label>
          <select class="form-control" id="sel1">
            <option>1</option>
            <option>2</option>
            <option>3</option>
          </select>
    </div>
    <div class="container">
      <table class="table table-bordered"  id="myTable">
        <thead>
          <tr>
            <th>Period #7</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
          </tr>
        </thead>
        <tbody>
          <!--<tr>
            <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td>
          </tr>
          <tr>
            <td>2</td><td>2</td><td>2</td><td>2</td><td>2</td>
          </tr>
          <tr>
            <td>3</td><td>3</td><td>3</td><td>3</td><td>3</td>
          </tr>
          <tr>
            <td>4</td><td>4</td><td>4</td><td>4</td><td>4</td>
          </tr>-->
        </tbody>
      </table>
      <button id = "clear" type ="button" class="btn btn-primary" onclick="Clear()">Clear</button>
    </div>
    <script>
        var already = 0;
        var floor = $("#sel1").val();
        var onFloor = 0;
        alert("floor is (waiting) " + floor);
        var CA = [];
        function Cell (num,specific) {
            this.num = num;
            this.specific = [];
            
        }
        for(var rr = 0;rr < 5;rr++){
             CA[rr] = [];
             for(var r = 0;r < 4;r++){
                 CA[rr][r] = new Cell();
                 CA[rr][r].num = 0;
                    //console.log("here's your stupid number " + CA[rr][r]);
             }
         }
        function clearCA(){
            for(var rr = 0;rr < 5;rr++){
                //CA[rr] = [];
                for(var r = 0;r < 4;r++){
                    CA[rr][r].num = 0;
                    console.log("here's your stupid number " + CA[rr][r].num);
                }
            }
        }
        function arrayClearCA(){
            alert("in arrayClearCA");
            for(var rr = 0;rr < 5;rr++){
                //CA[rr] = [];
                for(var r = 0;r < 4;r++){
                    CA[rr][r].specific = [];
                    //console.log("here's your stupid number " + CA[rr][r].num);
                }
            }
            read(0,0);
            alert("CA " + CA[0][0].specific[0]);
        }
        $( "#sel1" ).change(function() {
          alert( "Handler for .change() called." );
          floor = $("#sel1").val();
          alert("floor now " + floor );
          already = 0;
          ClearTable(4)  
          //beginAll();
        });
       // availability goes [day][period]
        var config = {
          apiKey: "AIzaSyB7quSFbdzOHH_S4B1TOntym_xTj4Yx6To",
          authDomain: "chrome-calendar.firebaseapp.com",
          databaseURL: "https://chrome-calendar.firebaseio.com",
          storageBucket: "chrome-calendar.appspot.com",
          messagingSenderId: "583488732443"
        };
        firebase.initializeApp(config);
        firebase.database().ref('/users').once('value').then(function(snapshot) {
          var username = snapshot.val();
          //alert(username);
          // ...
        });
        
        
        function getNum(){
            alert("in get num");
            var floorCarts;
            var floorRef = firebase.database().ref("/carts/floors/" + floor);
            floorRef.on("value", function(snapshot) {
               floorCarts = snapshot.numChildren();
                alert(floorCarts);
                onFloor = floorCarts;
                if(onFloor != 0){
                    beginAll();
                }
            });
        }
        getNum();
        function beginAll(){
            var Ref = firebase.database().ref();
            Ref.on("value", function(snapshot) {
                  var reset = snapshot.val();
                  //var started = sessionStorage.getItem('start');
                  //alert("Been set " + reset.beenSet);
                   if(reset.beenSet === "false"){
                       refill();
                       var updates = {};
                       updates['/beenSet'] = "true";
                       firebase.database().ref().update(updates);
                       /*firebase.database().ref().set({
                           beenSet = "true"
                       });*/
                       if(already === 0){
                           already = 1;
                           startFunc();
                       }
                   }
                   alert("alert " + already);
                   if(already === 0){
                       // Save data to sessionStorage
                       //sessionStorage.setItem('key', 1);
                       already = 1;
                       startFunc();
                   }
            });
        }
        var UID = sessionStorage.getItem('UID');
        function signOut(){
            firebase.auth().signOut().then(function() {
              // Sign-out successful.
                //alert("yo signing out");
                window.location.href="index.html";
            }, function(error) {
              // An error happened.
            });
        }
        //alert("UID " + UID);
        function refill(){
             for(var n = 0;n < 6;n++){
                 var cartLink;
                 var floor;
                 if(n === 0){
                     cartLink = "cart0";
                     floor = '1';
                 }
                 else if(n === 1){
                     cartLink = "cart1";
                     floor = '1';
                 }
                 else if(n === 2){
                     cartLink = "cart2";
                     floor = '2';
                 }
                 else if(n === 3){
                     cartLink = "cart3";
                     floor = '2';
                 }
                 else if(n === 4){
                     cartLink = "cart4";
                     floor = '3';
                 }
                 else if(n === 5){
                     cartLink = "cart5";
                     floor = '3';
                 }
                 for(var w = 0;w < 4;w++){
                     firebase.database().ref('/carts/floors/' + floor + '/' + cartLink + "/availability/" + w.toString()).set({
                        0: "true",
                        1: "true",
                        2: "true",
                        3: "true",
                        4: "true"
                      });
                 }
                 //Fill(cartLink,floor,addFloor);
                 
             }
            //alert("calling");
            //startFunc();
        }
       /* function Fill(cartLink,floor,callback){
            for(var w = 0;w < 4;w++){
                     firebase.database().ref('/carts/' + cartLink + "/availability/" + w.toString()).set({
                        one: "true",
                        two: "true",
                        three: "true",
                        four: "true",
                        five: "true"
                      });
                 }
            //callback(cartLink,floor);
        }*/
        /*function addFloor(cartLink,floor){
            firebase.database().ref("/carts/" + cartLink).set({
                 floor: floor
            });
        }*/
        var taken = [];
        var selected = [];
        for(var p = 0;p < 5;p++){
            taken[p] = [];
        }
        function Clickable (numID, color,yesList) {
            this.numID = numID;
            this.yesList = [];
            
        }
        //startFunc();
        function startFunc(){
            var j = 0;
            var k = 0;
            var dfd = $.Deferred();
            for(var k = 0;k < 5;k++){
                for(j = 0;j < 4;j++){
                    for(var x = 0;x < onFloor;x++){

                        checkAvailable(j,k,x);
                        //var temp = Math.floor((Math.random() * 2));
                        //console.log("temp "+temp);
                        console.log("really " + j +"what " + k);


                    }
                }
            }
        }
        function checkAvailable(j,k,x){
            //j is period, k is day
            //x is cart
            var specificCarts = [];
            //here is the error
            var tempX = x + (floor - 1) * 2;
            alert("temp X " + tempX);
            var cartVal = "cart" + tempX.toString();
            //console.log("here's your val " + cartVal);
            var kVal = 0;
            if(k == 0){
                //kVal = "one";
                kVal = '0';
            }
            else if(k == 1){
                //kVal = "two";
                kVal = '1';
            }
            else if(k == 2){
               // kVal = "three";
                kVal = '2';
            }
            else if(k == 3){
                //kVal = "four";
                kVal = '3';
            }
            else if(k == 4){
                //kVal = "five";
                kVal = '4';
            }
            //console.log("kVal " + kVal);
            //j is period
            var freeCarts = false;
            var numAvail = 0;
                var cartsRef = firebase.database().ref("/carts/floors/" + floor + '/' + cartVal + "/availability/"+ j + "/" + kVal);
                cartsRef.on("value", function(snapshot) {
                    var available = snapshot.val()
                    
                    console.log("availability " + available + " cartVal " + cartVal + " kVal " + kVal + " period " + j);
                    if(available == "true"){
                        //console.log("yo12");
                        freeCarts = true;
                    }
                    else if(available == "false"){
                        freeCarts = false;
                    }
                    console.log("potato " + x + " row " + j + " col " + k);
                    if((x == 2) && (j == 0) && (kVal == "one")){
                        alert("hey "  + freeCarts);
                    }
                    if(freeCarts == true){
                        alert(tempX);
                        //console.log("we are about to say yes");
                        //taken[j][k] = "yes";
                        console.log("before " + CA[k][j].num);
                        var temp = CA[k][j].num;
                        console.log("temp is " + temp);
                        CA[k][j].num = (temp + 1);
                        console.log("after " + CA[k][j].num);
                        console.log("spiders " + x + " row " + j + " col " + k);
                        CA[k][j].specific.push(tempX);
                        //taken[j][k] += 1;
                        //alert("say yes");
                    }
                    else if(freeCarts == false){
                        //taken[j][k] = "no";
                        console.log("say no");
                    }
                   /* if(x === 5){
                        alert("done for this round");
                        CA[x][j].specific = specificCarts;
                    }*/
                    console.log("j" + j);
                    console.log("k" + k);
                    //console.log("count" + count);
                    //console.log("numcarts" + numCarts);
                    if((j === 3) && (k === 4) && (x === (onFloor - 1))){
                           alert("go again mate");
                           console.log("WE ARE MAKING A CALL");
                           account();
                           //myFunction();
                     }
                    /*var numCarts = snapshot.numChildren();
                    var count = 0;
                  // The callback function will get called twice, once for "fred" and once for "barney"
                    //console.log("in cartsref");
                    snapshot.forEach(function(childSnapshot) {
                    count++;
                   // console.log("per cart");
                    // key will be "fred" the first time and "barney" the second time
                    //var key = childSnapshot.key();
                    // childData will be the actual contents of the child
                    var available = childSnapshot.val();
                    //var available = childData.
                    //var available = childData.availability.child(kVal).val();
                    console.log("availability " + available);
                    if(available == "true"){
                        console.log("yo12");
                        freeCarts = true;
                    }
                    else if(available == "false"){
                        freeCarts = false;
                    }
                        
                    if(freeCarts == true){
                        //console.log("we are about to say yes");
                        taken[j][k] = "yes";
                        alert("say yes");
                    }
                    else if(freeCarts == false){
                        taken[j][k] = "no";
                        console.log("say no");
                    }
                    console.log("j" + j);
                    console.log("k" + k);
                    console.log("count" + count);
                    console.log("numcarts" + numCarts);
                    if((j === 3) && (k === 4) && (count === numCarts)){
                            alert("go again mate");
                           console.log("WE ARE MAKING A CALL");
                           myFunction();
                     }
                  });*/
                    
                });
        }
        function account(){
            for(var ii = 0;ii < 5;ii++){
                for(var jj = 0;jj < 4;jj++){
                   // alert("availability CA " + CA[ii][jj]);
                    if(CA[ii][jj].num !== 0){
                        taken[ii][jj] = "yes";
                    }
                    else{
                        taken[ii][jj] = "no";
                    }
                }
            }
            clearCA();
            myFunction();
            
        }
        //myFunction fills in table;
        function myFunction(){
         var clicked = 0;
         console.log("yoyoy");
            for(var i = 0;i < 4;i++){
                var one = taken[0][i];
                var two = taken[1][i];
                var three = taken[2][i];
                var four = taken[3][i];
                var five = taken[4][i];
                clicked++;
                $('#myTable tr:last').after('<tr><td>'+(i+1)+'</td><td class=' + one +'  id= '+(1+i*5).toString()+'>'+(1+i*5).toString()+'</td><td class=' + two +' id= '+(2+i*5).toString()+'>'+(2+i*5).toString()+'</td><td class=' + three +' id= '+(3+i*5).toString()+'>'+(3+i*5).toString()+'</td><td class=' + four +' id= '+(4+i*5).toString()+'>'+(4+i*5).toString()+'</td>'+(5+i*5).toString()+'<td class=' + five +' id=  '+(5+i*5).toString()+'>'+(5+i*5).toString()+'</td></tr>'); 
            }
            //$('#myTable tr:last').remove();
        }
        $(document).ready(function() {
            $("table").click(function(event) {
                //alert(event.target.id);
                var ID = event.target.id;
                var Color = $('#'+ID).attr("class");
                //alert("color " + Color);
                if(Color === 'yes'){
                    $('#'+ID).css('background-color','gold');
                    $('#'+ID).css('color','black');
                    selected.push(new Clickable(ID,Color));
                }
            });
        });
        
        function Clear(){
            alert("clear called");
            console.log("sup");
            for(var q = 0;q < selected.length;q++){
                console.log("rawr" + selected.length);
                var tagOne;
                var tagTwo;
                var tagThree;
                var tempTwo;
                var tempOne;
                var tempInt = parseInt(selected[q].numID,10);
                
                //alert("wup");
                if((tempInt >= 1) && (tempInt <= 5)){
                    tagOne = '0';
                    tagTwo = tempInt ;
                    tempOne = 0;
                }
                else if((tempInt  >= 6) && (tempInt <= 10)){
                    tagOne = '1';
                    tagTwo = tempInt  - 5;
                    tempOne = 1;
                }
                else if((tempInt  >= 11) && (tempInt  <= 15)){
                    tagOne = '2';
                    tagTwo = tempInt  - 10;
                    tempOne = 2;
                }
                else if((tempInt >= 16) && (tempInt  <= 20)){
                    tagOne = '3';
                    tagTwo = tempInt - 15;
                    tempOne = 3;
                }
                
                if(tagTwo === 1){
                    tagTwo = "0";
                    tempTwo = 0;
                }
                else if(tagTwo === 2){
                    tagTwo = "1";
                    tempTwo = 1;
                }
                else if(tagTwo === 3){
                    tagTwo = "2";
                    tempTwo = 2;
                }
                else if(tagTwo === 4){
                    tagTwo = "3";
                    tempTwo = 3;
                }
                else if(tagTwo === 5){
                    tagTwo = "4";
                    tempTwo = 4;
                }
                //tempTwo is days
                //tempOne is periods
                
                //alert(tagOne);
                alert("tagTwo " + tagTwo);
                alert("tempOne " + tempOne + " tempTwo " + tempTwo);
                alert("tagThree " + CA[tempTwo][tempOne].specific[0]);
                tagThree = CA[tempTwo][tempOne].specific[0];
                read(tempTwo,tempOne);
                newUpdate(tagOne, tagTwo, tagThree);
                 //var updates = {};
                  //updates['/carts/cart1/availability/' + tagOne + '/' + tagTwo] = "false";
                  //firebase.database().ref().update(updates);
                
                console.log("x0x");
                if(selected[q].color === "no"){
                    $('#'+selected[q].numID).css('background-color','#0d1a26');
                    $('#'+selected[q].numID).css('color','white');
                }
                else{
                    $('#'+selected[q].numID).css('background-color','#00ccff');
                    $('#'+selected[q].numID).css('color','black');
                }
            }
            selected.length = 0;
            //console.log("here's where it went south");
            already = 0;
            arrayClearCA();
            ClearTable(4);
            //startFunc();
        }
        function newUpdate(tagOne, tagTwo, tagThree){
            alert("cart "+tagThree);
            if(tagThree === 0){
                tagThree = "cart0";
            }
            else if(tagThree === 1){
                tagThree = "cart1";
            }
            else if(tagThree === 2){
                tagThree = "cart2";
            }
            else if(tagThree === 3){
                tagThree = "cart3";
            }
            else if(tagThree === 4){
                tagThree = "cart4";
            }
            else if(tagThree === 5){
                tagThree = "cart5";
            }
            alert("cart "+ tagThree);
            var updates = {};
            alert("floor now " + floor);
            updates['/carts/floors/'+ floor + '/' + tagThree+'/availability/' + tagOne + '/' + tagTwo] = "false";
            firebase.database().ref().update(updates);
        }
        function read(k,j){
            var temp = CA[k][j].specific.length;
            for(var iii = 0;iii < temp;iii++){
                console.log("panda " + CA[k][j].specific[iii]);
            }
        }
        function ClearTable(until){
            for(var t = 0; t < until;t++){
                console.log("trying to clear here");
                $('#myTable tr:last').remove();
            }
            if(already === 0){
                alert("ready to beginAll");
                //already = 1;
                beginAll();
            }
        }
    </script>
    </body>
</html>
